<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500&display=swap">
  <style>
    body { 
      font-family: 'Roboto', Arial, sans-serif; 
      padding: 12px; 
      margin: 0;
      background-color: #f9f9f9;
      color: #333;
    }
    
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }
    
    h3 {
      margin: 0;
      color: #1a73e8;
      font-weight: 500;
    }
    
    .tabs {
      display: flex;
      border-bottom: 1px solid #dadce0;
      margin-bottom: 12px;
      width: 100%;
    }
    
    .tab {
      flex: 1;
      padding: 6px 5px;
      cursor: pointer;
      border-bottom: 2px solid transparent;
      color: #5f6368;
      font-weight: 500;
      font-size: 13px;
      white-space: nowrap;
      text-align: center;
    }
    
    .tab.active {
      color: #1a73e8;
      border-bottom: 2px solid #1a73e8;
    }
    
    .tab-content {
      display: none;
      padding: 12px;
    }
    
    .tab-content.active {
      display: block;
    }
    
    /* API Tool Styles */
    .container { display: flex; flex-direction: column; gap: 16px; }
    .card { background: #fff; border-radius: 8px; padding: 16px; box-shadow: 0 1px 3px rgba(0,0,0,0.12); }
    .form-group { margin-bottom: 12px; }
    label { display: block; margin-bottom: 4px; font-weight: 500; font-size: 13px; }
    input, select, textarea {
      width: 100%; padding: 8px; border: 1px solid #dadce0; border-radius: 4px; box-sizing: border-box; font-family: inherit;
    }
    textarea { min-height: 80px; font-family: "Roboto Mono", monospace; }
    .button {
      background: #1a73e8; color: white; padding: 8px 16px; border: none; cursor: pointer; border-radius: 4px;
      font-weight: 500; transition: background 0.2s;
    }
    .button:hover { background: #1765cc; }
    .button.secondary { background: #f1f3f4; color: #1a73e8; border: 1px solid #dadce0; }
    .button.secondary:hover { background: #e8eaed; }
    .button-group { display: flex; gap: 8px; }
    #resultArea { margin-top: 16px; max-height: 300px; overflow-y: auto; }
    .result-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
    .status-badge { padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: 500; }
    .status-success { background: #e6f4ea; color: #137333; }
    .status-error { background: #fce8e6; color: #c5221f; }
    pre { background: #f8f9fa; padding: 8px; border-radius: 4px; overflow-x: auto; font-family: "Roboto Mono", monospace; font-size: 12px; }
    .loader {
      border: 3px solid #f3f3f3; border-top: 3px solid #1a73e8; border-radius: 50%; width: 20px; height: 20px;
      animation: spin 2s linear infinite; margin: 10px auto; display: none;
    }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    .helper-text { font-size: 12px; color: #5f6368; margin-top: 4px; }
    
    /* AI Chat Styles */
    .chat-container {
      display: flex;
      flex-direction: column;
      height: calc(100vh - 300px);
      min-height: 300px;
      position: relative;
    }
    
    #aiChatHistory {
      flex-grow: 1;
      overflow-y: auto;
      border: 1px solid #dadce0;
      border-radius: 8px;
      padding: 12px;
      margin-bottom: 12px;
      background-color: white;
      box-shadow: 0 1px 2px rgba(0,0,0,0.1);
      scroll-behavior: smooth;
    }
    
    .message {
      margin-bottom: 12px;
      padding: 8px 12px;
      border-radius: 8px;
      max-width: 85%;
      word-wrap: break-word;
    }
    
    .user-message {
      background-color: #e8f0fe;
      align-self: flex-end;
      margin-left: auto;
      border-bottom-right-radius: 2px;
    }
    
    .ai-message {
      background-color: #f1f3f4;
      align-self: flex-start;
      margin-right: auto;
      border-bottom-left-radius: 2px;
    }
    
    .message-header {
      font-size: 12px;
      color: #5f6368;
      margin-bottom: 4px;
      font-weight: 500;
    }
    
    .message-content {
      font-size: 14px;
      line-height: 1.4;
    }
    
    .input-container {
      display: flex;
      margin-top: auto;
      background-color: white;
      padding: 8px;
      border-radius: 8px;
      box-shadow: 0 1px 2px rgba(0,0,0,0.1);
    }
    
    #aiMessageInput {
      flex-grow: 1;
      padding: 8px 12px;
      border: 1px solid #dadce0;
      border-radius: 4px;
      font-size: 14px;
      resize: vertical;
      min-height: 60px;
      max-height: 200px;
      overflow-y: auto;
      line-height: 1.4;
      transition: height 0.1s ease;
    }
    
    .model-selector {
      display: flex;
      align-items: center;
      margin-bottom: 12px;
      background-color: white;
      padding: 8px;
      border-radius: 8px;
      box-shadow: 0 1px 2px rgba(0,0,0,0.1);
    }
    
    .feature-buttons {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 12px;
      background-color: white;
      padding: 8px;
      border-radius: 8px;
      box-shadow: 0 1px 2px rgba(0,0,0,0.1);
    }
    
    .feature-button {
      background-color: #e8f0fe;
      color: #1a73e8;
      border: 1px solid #d2e3fc;
      border-radius: 16px;
      padding: 4px 12px;
      font-size: 12px;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .feature-button:hover {
      background-color: #d2e3fc;
    }
    
    /* Utilities Styles */
    .utilities-container {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    
    .utility-card {
      background: white;
      border-radius: 8px;
      padding: 16px;
      box-shadow: 0 1px 2px rgba(0,0,0,0.1);
    }
    
    .utility-title {
      font-size: 14px;
      font-weight: 500;
      color: #1a73e8;
      margin-bottom: 8px;
    }
    
    .utility-description {
      font-size: 12px;
      color: #5f6368;
      margin-bottom: 12px;
    }

    /* Add these styles in the <style> section */
    .loading {
      display: inline-block;
      width: 16px;
      height: 16px;
      border: 2px solid rgba(255,255,255,0.3);
      border-radius: 50%;
      border-top-color: white;
      animation: spin 1s ease-in-out infinite;
      margin-right: 5px;
      vertical-align: middle;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .loading-container {
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 8px;
      background: #f8f9fa;
      border-radius: 4px;
      margin: 8px 0;
    }

    .loading-text {
      color: #5f6368;
      font-size: 14px;
      margin-left: 8px;
    }

    .response-actions {
      display: flex;
      gap: 8px;
      margin: 12px 0;
      flex-wrap: wrap;
      position: sticky;
      top: 0;
      background: white;
      padding: 8px 0;
      z-index: 1;
    }
    
    .response-actions .button {
      flex: 1;
      min-width: 120px;
      position: relative;
    }
    
    .response-actions .button.loading {
      color: transparent;
    }
    
    .response-actions .button.loading::after {
      content: '';
      position: absolute;
      left: 50%;
      top: 50%;
      transform: translate(-50%, -50%);
      width: 16px;
      height: 16px;
      border: 2px solid #f3f3f3;
      border-top: 2px solid #1a73e8;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    
    .visualization-container {
      margin-top: 12px;
      padding: 12px;
      background: #f8f9fa;
      border-radius: 4px;
      display: none;
      max-height: 400px;
      overflow-y: auto;
    }
    
    .visualization-container table {
      font-size: 12px;
    }
    
    .visualization-container td, 
    .visualization-container th {
      padding: 4px 8px;
      max-width: 200px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    
    .visualization-container.active {
      display: block;
    }
    
    .chart-container {
      width: 100%;
      height: 300px;
      margin-top: 8px;
    }

    /* Add these styles to the existing <style> section */
    .export-notification {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 1000;
      min-width: 300px;
      max-width: 80%;
      margin: 0 20px;
      pointer-events: none;
    }
    
    .export-notification .notification-content {
      padding: 12px 16px;
      border-radius: 4px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
      display: flex;
      align-items: center;
      justify-content: space-between;
      animation: slideIn 0.3s ease-out;
      margin-bottom: 8px;
      pointer-events: auto;
      position: relative;
      top: 0;
    }
    
    .export-notification.success .notification-content {
      background-color: #e6f4ea;
      color: #137333;
      border: 1px solid #137333;
    }
    
    .export-notification.error .notification-content {
      background-color: #fce8e6;
      color: #c5221f;
      border: 1px solid #c5221f;
    }
    
    .export-notification button {
      background: none;
      border: none;
      color: inherit;
      font-size: 20px;
      cursor: pointer;
      padding: 0 8px;
      margin-left: 8px;
      opacity: 0.7;
    }
    
    .export-notification button:hover {
      opacity: 1;
    }
    
    @keyframes slideIn {
      from {
        transform: translateX(100%);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }

    /* Add notification styles */
    .notification {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      padding: 10px 15px;
      border-radius: 5px;
      color: white;
      font-weight: 500;
      z-index: 1000;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
      animation: slide-up 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    
    .notification-close {
      background: none;
      border: none;
      color: white;
      font-size: 20px;
      cursor: pointer;
      margin-left: 12px;
      opacity: 0.8;
      padding: 0 5px;
      line-height: 1;
    }
    
    .notification-close:hover {
      opacity: 1;
    }
    
    .notification.info {
      background-color: #1a73e8;
    }
    
    .notification.success {
      background-color: #0f9d58;
    }
    
    .notification.error {
      background-color: #d93025;
    }
    
    .notification.fade-out {
      opacity: 0;
      transition: opacity 0.3s ease;
    }
    
    @keyframes slide-up {
      from { transform: translate(-50%, 20px); opacity: 0; }
      to { transform: translate(-50%, 0); opacity: 1; }
    }

    /* Remove Action Panel Styles but keep other essential styles */
    
    .code-block {
      background-color: #f8f9fa;
      border-radius: 4px;
      padding: 8px;
      margin: 8px 0;
      font-family: 'Roboto Mono', monospace;
      font-size: 12px;
      overflow-x: auto;
      position: relative;
    }
    
    .code-block pre {
      margin: 0;
      white-space: pre-wrap;
    }
    
    .code-actions {
      position: absolute;
      right: 8px;
      top: 8px;
      display: none;
    }
    
    .code-block:hover .code-actions {
      display: block;
    }
    
    .model-badge {
      display: inline-block;
      padding: 2px 6px;
      border-radius: 12px;
      font-size: 10px;
      background-color: #f1f3f4;
    }
    
    .model-badge.model-gemini {
      background-color: #d2e3fc;
      color: #1a73e8;
    }
    
    .model-badge.model-llama {
      background-color: #fad2cf;
      color: #c5221f;
    }
    
    .curl-section {
      margin-bottom: 15px;
      padding: 10px;
      background-color: #f8f9fa;
      border-radius: 4px;
    }
    
    .curl-section textarea {
      width: 100%;
      min-height: 100px;
      margin-bottom: 10px;
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-family: monospace;
      font-size: 12px;
    }
    
    .curl-section button {
      background-color: #007bff;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 4px;
      cursor: pointer;
    }
    
    .curl-section button:hover {
      background-color: #0056b3;
    }
    
    .chat-management-buttons {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin-top: 15px;
      background-color: white;
      padding: 10px;
      border-radius: 8px;
      box-shadow: 0 1px 2px rgba(0,0,0,0.1);
    }
    
    #apiTab {
      display: block; /* Show API tab by default */
    }

    .data-selection-panel {
      background-color: white;
      border-radius: 8px;
      box-shadow: 0 1px 2px rgba(0,0,0,0.1);
      margin-bottom: 12px;
      padding: 12px;
    }
    
    .data-selection-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }
    
    .data-selection-header h4 {
      margin: 0;
      font-size: 14px;
      color: #1a73e8;
    }
    
    .selection-status {
      font-size: 12px;
      color: #5f6368;
      font-style: italic;
    }
    
    .selection-status.active {
      color: #137333;
      font-weight: 500;
      font-style: normal;
    }
    
    .data-selection-options {
      display: flex;
      gap: 8px;
    }
    
    .notification.info {
      background-color: #1a73e8;
    }
  </style>
</head>
<body>
  <div class="tabs">
    <div class="tab active" onclick="switchTab('api')">API Tool</div>
    <div class="tab" onclick="switchTab('ai')">AI Chat</div>
    <div class="tab" onclick="switchTab('utilities')">Utilities</div>
  </div>
  
  <!-- API Tool Tab -->
  <div id="apiTab" class="tab-content" style="display: block;">
    <div class="curl-section">
      <h3>Import from cURL</h3>
      <textarea id="curlInput" placeholder="Paste your cURL command here..."></textarea>
      <button onclick="importFromCurl()">Import</button>
    </div>
    
    <div class="container">
      <div class="card">
        <h3>API Request Tool</h3>
        
        <div class="form-group">
          <label for="publicApiSelector">Popular APIs</label>
          <select id="publicApiSelector" onchange="loadPublicApi()">
            <option value="">-- Select a public API --</option>
            <option value="pokeapi">PokeAPI (Pokemon Data)</option>
            <option value="jsonplaceholder">JSONPlaceholder (Posts)</option>
            <option value="restcountries">REST Countries API</option>
            <option value="ipify">IPify (Your IP Address)</option>
            <option value="catfacts">Cat Facts API</option>
          </select>
          <p class="hint">Select a public API to pre-fill the request form</p>
        </div>
        
        <div class="form-group">
          <label for="apiUrl">API URL</label>
          <input type="text" id="apiUrl" placeholder="https://api.example.com/data">
        </div>
        
        <div class="form-group">
          <label for="apiMethod">Method</label>
          <select id="apiMethod">
            <option value="GET">GET</option>
            <option value="POST">POST</option>
            <option value="PUT">PUT</option>
            <option value="DELETE">DELETE</option>
            <option value="PATCH">PATCH</option>
          </select>
        </div>
        
        <div class="form-group">
          <label for="headers">Headers (JSON)</label>
          <textarea id="headers" placeholder='{"Content-Type": "application/json"}'></textarea>
        </div>
        
        <div class="form-group">
          <label>Query Parameters</label>
          <div id="queryParamsContainer">
            <div class="query-param-row">
              <input type="text" placeholder="Key" class="query-key">
              <input type="text" placeholder="Value" class="query-value">
            </div>
          </div>
          <button class="button secondary" onclick="addQueryParamRow()">Add Parameter</button>
        </div>
        
        <div class="form-group">
          <label for="apiBody">Request Body</label>
          <textarea id="apiBody" placeholder='{"key": "value"}'></textarea>
        </div>
        
        <div class="button-group">
          <button class="button" onclick="sendApiRequest()">Send Request</button>
          <button class="button secondary" onclick="clearForm()">Clear</button>
        </div>
      </div>
      
      <div id="resultContainer" class="card" style="display:none;">
        <div class="result-header">
          <h3>Response</h3>
          <div id="statusBadge" class="status-badge"></div>
        </div>
        <div class="response-actions">
          <button class="button secondary" onclick="copyResponse()">Copy Response</button>
          <button class="button secondary" onclick="addToSheet()">Add to Sheet</button>
          <button class="button secondary" onclick="visualizeResponse()">Visualize</button>
        </div>
        <pre id="resultArea"></pre>
      </div>
    </div>
  </div>
  
  <!-- AI Chat Tab -->
  <div id="aiTab" class="tab-content" style="display: none;">
    <div class="model-selector">
      <label for="modelSelect">AI Model:</label>
      <select id="modelSelect">
        <option value="gemini">Gemini 2.0 (High Quality)</option>
        <option value="llama">Llama 3 (Fast)</option>
      </select>
    </div>
    
    <div class="feature-buttons">
      <button class="feature-button" onclick="analyzeDataWithSelection()">Analyze Data</button>
      <button class="feature-button" onclick="generateChartWithSelection()">Create Chart</button>
      <button class="feature-button" onclick="formulaSuggestionWithSelection()">Formula Help</button>
    </div>
    
    <div class="data-selection-panel">
      <div class="data-selection-header">
        <h4>Data Selection</h4>
        <div class="selection-status" id="selectionStatus">No data selected</div>
      </div>
      <div class="data-selection-options">
        <button class="button secondary" onclick="selectCurrentRange()">Use Current Range</button>
        <button class="button secondary" onclick="selectEntireSheet()">Use Active Sheet</button>
      </div>
    </div>
    
    <div class="chat-container">
      <div id="aiChatHistory">
        <div class="placeholder-text">
          Start a conversation with AI to analyze your spreadsheet data or get help with formulas.
        </div>
      </div>
      
      <div class="input-container">
        <textarea 
          id="aiMessageInput" 
          placeholder="Type your message..." 
          rows="3"
          oninput="autoResizeTextarea(this)"
          onkeydown="handleKeyDown(event)"></textarea>
        <button id="sendButton" class="button" onclick="sendAIMessage()">Send</button>
      </div>
    </div>
    
    <!-- Chat management buttons at the bottom -->
    <div class="chat-management-buttons">
      <button class="button secondary" onclick="exportChat()">Export Chat</button>
      <button class="button secondary" onclick="clearChat()">Clear Chat</button>
    </div>
  </div>
  
  <!-- Utilities Tab -->
  <div id="utilitiesTab" class="tab-content" style="display: none;">
    <div class="utilities-container">
      <div class="utility-card">
        <div class="utility-title">Time Utilities</div>
        <div class="utility-description">Convert and format timestamps in your spreadsheet</div>
        <button class="button" onclick="google.script.run.convertAndInsertTimestamps()">Convert and Insert Timestamps</button>
      </div>
      
      <!-- Add more utility cards here as needed -->
    </div>
  </div>
  
  <script>
    // Switch between tabs
    function switchTab(tabName) {
      console.log("Switching to tab:", tabName);
      
      // Hide all tab content
      const tabContents = document.querySelectorAll('.tab-content');
      tabContents.forEach(tab => tab.style.display = 'none');
      
      // Remove active class from all tabs
      const tabs = document.querySelectorAll('.tab');
      tabs.forEach(tab => tab.classList.remove('active'));
      
      // Show selected tab and set it as active
      document.getElementById(tabName + 'Tab').style.display = 'block';
      document.querySelector(`.tab[onclick="switchTab('${tabName}')"]`).classList.add('active');
      
      // Load chat history if switching to AI tab
      if (tabName === 'ai') {
        loadChatHistory();
        document.getElementById('aiMessageInput').focus();
      }
    }
    
    // API Tool Functions
    function loadPublicApi() {
      const apiSelector = document.getElementById('publicApiSelector');
      const selectedApi = apiSelector.value;
      
      if (!selectedApi) return;
      
      // Clear form first
      clearForm();
      
      // Default headers for all APIs
      const headers = { 'Content-Type': 'application/json' };
      
      // Set API details based on selection
      switch(selectedApi) {
        case 'pokeapi':
          document.getElementById('apiUrl').value = 'https://pokeapi.co/api/v2/pokemon?limit=20';
          document.getElementById('apiMethod').value = 'GET';
          showNotification('PokeAPI selected - get data for 20 Pokemon', 'success');
          break;
          
        case 'jsonplaceholder':
          document.getElementById('apiUrl').value = 'https://jsonplaceholder.typicode.com/posts';
          document.getElementById('apiMethod').value = 'GET';
          showNotification('JSONPlaceholder API selected - get placeholder posts', 'success');
          break;
          
        case 'restcountries':
          document.getElementById('apiUrl').value = 'https://restcountries.com/v3.1/all';
          document.getElementById('apiMethod').value = 'GET';
          showNotification('REST Countries API selected - get information about all countries', 'success');
          break;
          
        case 'ipify':
          document.getElementById('apiUrl').value = 'https://api.ipify.org?format=json';
          document.getElementById('apiMethod').value = 'GET';
          showNotification('IPify API selected - get your current IP address', 'success');
          break;
          
        case 'catfacts':
          document.getElementById('apiUrl').value = 'https://catfact.ninja/fact';
          document.getElementById('apiMethod').value = 'GET';
          showNotification('Cat Facts API selected - get a random cat fact', 'success');
          break;
      }
      
      // Add headers to text area
      document.getElementById('headers').value = JSON.stringify(headers, null, 2);
    }
    
    function sendApiRequest() {
      const url = document.getElementById('apiUrl').value;
      const method = document.getElementById('apiMethod').value;
      const headersStr = document.getElementById('headers').value;
      const body = document.getElementById('apiBody').value;
      const sendButton = document.querySelector('.button-group .button');
      const resultContainer = document.getElementById('resultContainer');
      
      // Validate required fields
      if (!url) {
        showNotification('Please enter an API URL', 'error');
        return;
      }
      
      // Show loading state
      sendButton.disabled = true;
      sendButton.innerHTML = '<span class="loading"></span> Sending...';
      resultContainer.style.display = 'none';
      
      const queryParams = {};
      document.querySelectorAll('.query-param-row').forEach(row => {
        const key = row.querySelector('.query-key').value;
        const value = row.querySelector('.query-value').value;
        if (key && value) {
          queryParams[key] = value;
        }
      });
      
      google.script.run
        .withSuccessHandler(response => {
          const resultArea = document.getElementById('resultArea');
          const statusBadge = document.getElementById('statusBadge');
          
          resultContainer.style.display = 'block';
          resultArea.textContent = JSON.stringify(response, null, 2);
          statusBadge.textContent = 'Success';
          statusBadge.className = 'status-badge status-success';
          
          // Reset button
          sendButton.disabled = false;
          sendButton.innerHTML = 'Send Request';
        })
        .withFailureHandler(error => {
          const resultArea = document.getElementById('resultArea');
          const statusBadge = document.getElementById('statusBadge');
          
          resultContainer.style.display = 'block';
          resultArea.textContent = error.toString();
          statusBadge.textContent = 'Error';
          statusBadge.className = 'status-badge status-error';
          
          // Reset button
          sendButton.disabled = false;
          sendButton.innerHTML = 'Send Request';
        })
        .sendApiRequest(url, method, queryParams, body, headersStr);
    }
    
    function clearForm() {
      document.getElementById('publicApiSelector').value = '';
      document.getElementById('apiUrl').value = '';
      document.getElementById('apiMethod').value = 'GET';
      document.getElementById('headers').value = '';
      document.getElementById('apiBody').value = '';
      document.getElementById('queryParamsContainer').innerHTML = `
        <div class="query-param-row">
          <input type="text" placeholder="Key" class="query-key">
          <input type="text" placeholder="Value" class="query-value">
        </div>
      `;
      document.getElementById('resultContainer').style.display = 'none';
    }
    
    // AI Chat Functions
    function sendAIMessage() {
      const messageInput = document.getElementById('aiMessageInput');
      const sendButton = document.getElementById('sendButton');
      const chatHistory = document.getElementById('aiChatHistory');
      const model = document.getElementById('modelSelect').value;
      
      const message = messageInput.value.trim();
      if (!message) return;
      
      // Add user message to chat
      chatHistory.innerHTML += formatMessage(message, 'user', model);
      
      // Clear input
      messageInput.value = '';
      
      // Disable send button and show loading state
      sendButton.disabled = true;
      sendButton.innerHTML = '<span class="loading"></span> Sending...';
      
      // Scroll to bottom after adding user message
      scrollToBottom(chatHistory);
      
      // Save chat history immediately after adding user message
      saveChatHistory();
      
      // Get selected ranges for context
      const contextRanges = getSelectedRanges();
      
      // Send message to server
      google.script.run
        .withSuccessHandler(response => {
          // Add AI response to chat
          const messageElement = formatMessage(response, 'ai', model);
          chatHistory.innerHTML += messageElement;
          
          // Scroll to bottom after adding AI response
          scrollToBottom(chatHistory);
          
          // Reset button
          sendButton.disabled = false;
          sendButton.innerHTML = 'Send';
          
          // Focus input for next message
          messageInput.focus();
          
          // Save updated chat history
          saveChatHistory();
        })
        .withFailureHandler(error => {
          // Handle error
          chatHistory.innerHTML += formatMessage(
            `Error: ${error.message || 'Something went wrong. Please try again.'}`, 
            'ai', 
            model
          );
          
          // Scroll to bottom after adding error message
          scrollToBottom(chatHistory);
          
          // Reset button
          sendButton.disabled = false;
          sendButton.innerHTML = 'Send';
          
          // Save chat history even with error
          saveChatHistory();
        })
        .chatWithAI(message, model, contextRanges);
    }
    
    // Data selection and feature variables
    let selectedData = null;
    let selectedRange = null;
    let selectedSheet = null;
    
    // Function to update data selection status
    function updateSelectionStatus() {
      const statusElement = document.getElementById('selectionStatus');
      
      if (!selectedData) {
        statusElement.textContent = 'No data selected';
        statusElement.className = 'selection-status';
        return;
      }
      
      statusElement.textContent = `Selected: ${selectedSheet} - ${selectedRange}`;
      statusElement.className = 'selection-status active';
    }
    
    // Function to select current range
    function selectCurrentRange() {
      showNotification('Getting current selection...', 'info');
      
      google.script.run
        .withSuccessHandler(response => {
          if (response && response.length > 0) {
            selectedData = response[0];
            selectedRange = selectedData.range;
            selectedSheet = selectedData.sheetName;
            updateSelectionStatus();
            showNotification(`Selected range: ${selectedSheet}!${selectedRange}`, 'success');
          } else {
            showNotification('No range selected. Please select cells in your spreadsheet.', 'error');
          }
        })
        .withFailureHandler(error => {
          console.error('Error getting selection:', error);
          showNotification('Failed to get selection: ' + error.message, 'error');
        })
        .getSelectedRanges();
    }
    
    // Function to select entire active sheet
    function selectEntireSheet() {
      showNotification('Using entire active sheet...', 'info');
      
      google.script.run
        .withSuccessHandler(response => {
          selectedSheet = response.sheetName;
          selectedRange = response.range;
          selectedData = response;
          updateSelectionStatus();
          showNotification(`Selected entire sheet: ${selectedSheet}`, 'success');
        })
        .withFailureHandler(error => {
          console.error('Error selecting sheet:', error);
          showNotification('Failed to select sheet: ' + error.message, 'error');
        })
        .getActiveSheetData();
    }
    
    // Function to check if data is selected
    function checkDataSelected() {
      if (!selectedData) {
        showNotification('Please select data first using the data selection options.', 'error');
        return false;
      }
      return true;
    }
    
    // Function to analyze data with selection
    function analyzeDataWithSelection() {
      if (!checkDataSelected()) return;
      
      const model = document.getElementById('modelSelect').value;
      const chatHistory = document.getElementById('aiChatHistory');
      const userPrompt = `Please analyze this data from ${selectedSheet}!${selectedRange} and provide insights.`;
      
      // Add user message to chat
      chatHistory.innerHTML += formatMessage(userPrompt, 'user');
      
      // Scroll to bottom after adding message
      scrollToBottom(chatHistory);
      
      // Send to backend with context
      const button = document.getElementById('sendButton');
      button.disabled = true;
      button.innerHTML = 'Sending...';
      
      google.script.run
        .withSuccessHandler(response => {
          // Add AI response
          const messageElement = formatMessage(response, 'ai', model);
          chatHistory.innerHTML += messageElement;
          
          // Scroll to bottom after adding AI response
          scrollToBottom(chatHistory);
          
          // Reset button
          button.disabled = false;
          button.innerHTML = 'Send';
          
          // Save updated chat history
          saveChatHistory();
        })
        .withFailureHandler(error => {
          chatHistory.innerHTML += formatMessage(
            `Error: ${error.message || 'Something went wrong. Please try again.'}`, 
            'ai', 
            model
          );
          
          scrollToBottom(chatHistory);
          button.disabled = false;
          button.innerHTML = 'Send';
          saveChatHistory();
        })
        .analyzeDataRange(selectedData, userPrompt, model);
    }
    
    // Function to generate chart with selection
    function generateChartWithSelection() {
      if (!checkDataSelected()) return;
      
      const model = document.getElementById('modelSelect').value;
      const chatHistory = document.getElementById('aiChatHistory');
      const userPrompt = `Please suggest the best chart type for this data from ${selectedSheet}!${selectedRange} and explain why.`;
      
      // Add user message to chat
      chatHistory.innerHTML += formatMessage(userPrompt, 'user');
      
      // Scroll to bottom after adding message
      scrollToBottom(chatHistory);
      
      // Send to backend
      const button = document.getElementById('sendButton');
      button.disabled = true;
      button.innerHTML = 'Sending...';
      
      google.script.run
        .withSuccessHandler(response => {
          // Add AI response
          const messageElement = formatMessage(response, 'ai', model);
          chatHistory.innerHTML += messageElement;
          
          // Scroll to bottom after adding AI response
          scrollToBottom(chatHistory);
          
          // Reset button
          button.disabled = false;
          button.innerHTML = 'Send';
          
          // Save updated chat history
          saveChatHistory();
        })
        .withFailureHandler(error => {
          chatHistory.innerHTML += formatMessage(
            `Error: ${error.message || 'Something went wrong. Please try again.'}`, 
            'ai', 
            model
          );
          
          scrollToBottom(chatHistory);
          button.disabled = false;
          button.innerHTML = 'Send';
          saveChatHistory();
        })
        .suggestChartForData(selectedData, userPrompt, model);
    }
    
    // Function to get formula suggestions
    function formulaSuggestionWithSelection() {
      if (!checkDataSelected()) return;
      
      const model = document.getElementById('modelSelect').value;
      const chatHistory = document.getElementById('aiChatHistory');
      const userPrompt = `Suggest useful formulas or functions I could use with this data from ${selectedSheet}!${selectedRange}.`;
      
      // Add user message to chat
      chatHistory.innerHTML += formatMessage(userPrompt, 'user');
      
      // Scroll to bottom after adding message
      scrollToBottom(chatHistory);
      
      // Send to backend
      const button = document.getElementById('sendButton');
      button.disabled = true;
      button.innerHTML = 'Sending...';
      
      google.script.run
        .withSuccessHandler(response => {
          // Add AI response
          const messageElement = formatMessage(response, 'ai', model);
          chatHistory.innerHTML += messageElement;
          
          // Scroll to bottom after adding AI response
          scrollToBottom(chatHistory);
          
          // Reset button
          button.disabled = false;
          button.innerHTML = 'Send';
          
          // Save updated chat history
          saveChatHistory();
        })
        .withFailureHandler(error => {
          chatHistory.innerHTML += formatMessage(
            `Error: ${error.message || 'Something went wrong. Please try again.'}`, 
            'ai', 
            model
          );
          
          scrollToBottom(chatHistory);
          button.disabled = false;
          button.innerHTML = 'Send';
          saveChatHistory();
        })
        .suggestFormulas(selectedData, userPrompt, model);
    }
    
    function formatMessage(content, sender, model) {
      const timestamp = new Date().toLocaleTimeString();
      const senderName = sender === 'user' ? 'You' : 'AI';
      const messageClass = sender === 'user' ? 'user-message' : 'ai-message';
      
      let formattedContent = content;
      if (sender === 'ai') {
        // Convert markdown formatting to HTML
        formattedContent = formattedContent
          .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
          .replace(/\*(.*?)\*/g, '<em>$1</em>')
          .replace(/```([\s\S]*?)```/g, '<div class="code-block"><pre>$1</pre></div>')
          .replace(/`([^`]+)`/g, '<code>$1</code>')
          .replace(/^# (.*$)/gm, '<h1>$1</h1>')
          .replace(/^## (.*$)/gm, '<h2>$1</h2>')
          .replace(/^### (.*$)/gm, '<h3>$1</h3>')
          .replace(/^#### (.*$)/gm, '<h4>$1</h4>')
          .replace(/^\s*(\d+)\.\s(.*)$/gm, '<ol start="$1"><li>$2</li></ol>')
          .replace(/^\s*-\s(.*)$/gm, '<ul><li>$1</li></ul>')
          .replace(/<\/ul><ul>/g, '')
          .replace(/<\/ol><ol start="[0-9]+?">/g, '')
          .replace(/\n/g, '<br>');
      }
      
      let modelBadge = '';
      if (sender === 'ai' && model) {
        const modelName = model === 'gemini' ? 'Gemini' : 'Llama';
        modelBadge = `<span class="model-badge model-${model}">${modelName}</span>`;
      }
      
      return `
        <div class="message ${messageClass}">
          <div class="message-header">${timestamp} - ${senderName} ${modelBadge}</div>
          <div class="message-content">${formattedContent}</div>
        </div>
      `;
    }
    
    function addActionButtonsToCodeBlocks() {
      // After rendering a message, find any code blocks and add action buttons
      setTimeout(() => {
        document.querySelectorAll('.code-block').forEach(block => {
          if (!block.querySelector('.code-actions')) {
            const code = block.querySelector('pre').textContent;
            const actionsDiv = document.createElement('div');
            actionsDiv.className = 'code-actions';
            actionsDiv.innerHTML = `
              <button class="message-action-button" onclick="copyToClipboard('${code.replace(/'/g, "\\'")}')">Copy</button>
              <button class="message-action-button" onclick="applyCode('${code.replace(/'/g, "\\'")}')">Apply</button>
            `;
            block.appendChild(actionsDiv);
          }
        });
      }, 100);
    }
    
    function copyToClipboard(text) {
      navigator.clipboard.writeText(text)
        .then(() => showNotification('Copied to clipboard', 'success'))
        .catch(() => showNotification('Failed to copy to clipboard', 'error'));
    }
    
    function applyCode(code) {
      // Detect if code is a formula
      if (code.trim().startsWith('=')) {
        executeAction('applyFormula', code);
      } else {
        showNotification('Only formulas can be applied directly', 'error');
      }
    }
    
    function handleKeyDown(event) {
      if (event.key === 'Enter' && !event.shiftKey) {
        event.preventDefault();
        sendAIMessage();
      }
    }
    
    function clearChat() {
      if (confirm('Are you sure you want to clear the chat history?')) {
        document.getElementById('aiChatHistory').innerHTML = `
          <div class="placeholder-text">
            Start a conversation with AI to analyze your spreadsheet data or get help with formulas.
          </div>
        `;
        
        try {
          if (isLocalStorageAvailable()) {
            localStorage.removeItem('aiChatHistory');
            showNotification('Chat history cleared', 'success');
          }
        } catch (error) {
          console.error('Error clearing chat history:', error);
        }
      }
    }
    
    function exportChat() {
      const chatHistory = document.getElementById('aiChatHistory');
      const messages = Array.from(chatHistory.querySelectorAll('.message')).map(msg => {
        const header = msg.querySelector('.message-header').textContent.trim();
        const content = msg.querySelector('.message-content').textContent.trim();
        const timeMatch = header.match(/(\d{1,2}:\d{2}:\d{2})/);
        
        // Extract model from the model badge in the header
        const modelBadge = msg.querySelector('.model-badge');
        const model = modelBadge ? modelBadge.textContent.trim().toUpperCase() : '';
        
        // Format the message with proper timestamp and model
        return `${timeMatch ? timeMatch[1] : ''}\t${header.includes('You') ? 'User' : 'AI'}\t${content}\t${model}`;
      }).join('\n');
      
      // Export chat to Google Sheets
      google.script.run
        .withSuccessHandler(() => {
          showNotification('Chat exported successfully!', 'success');
        })
        .withFailureHandler(error => {
          showNotification('Error exporting chat: ' + error.message, 'error');
        })
        .exportChatHistory(messages);
    }
    
    function showNotification(message, type = 'info') {
      console.log(`Notification (${type}): ${message}`);
      
      const notification = document.createElement('div');
      notification.className = `notification ${type}`;
      
      // Create content with close button
      notification.innerHTML = `
        ${message}
        <button class="notification-close" onclick="this.parentElement.remove()">Ã—</button>
      `;
      
      // Add notification to the DOM
      document.body.appendChild(notification);
      
      // Automatically remove after 5 seconds
      const autoCloseTimeout = setTimeout(() => {
        notification.classList.add('fade-out');
        setTimeout(() => notification.remove(), 300);
      }, 5000);
      
      // Stop auto-close when close button is clicked
      notification.querySelector('.notification-close').addEventListener('click', () => {
        clearTimeout(autoCloseTimeout);
      });
    }

    function getSelectedRanges() {
      return google.script.run.getSelectedRanges();
    }
    
    function saveChatHistory() {
      try {
        const chatHistory = document.getElementById('aiChatHistory').innerHTML;
        
        if (!isLocalStorageAvailable()) {
          console.warn('localStorage is not available. Chat history will not be persisted.');
          return;
        }
        
        // Check size - if too large, we'll need to trim it
        if (chatHistory.length > 4000000) { // ~4MB limit
          console.warn('Chat history is too large, trimming older messages');
          const historyDiv = document.getElementById('aiChatHistory');
          const messages = historyDiv.querySelectorAll('.message');
          
          // Remove the oldest 20% of messages
          const removeCount = Math.ceil(messages.length * 0.2);
          for (let i = 0; i < removeCount; i++) {
            if (messages[i] && messages[i].parentNode) {
              messages[i].parentNode.removeChild(messages[i]);
            }
          }
          
          // Try saving again with the trimmed history
          const trimmedHistory = historyDiv.innerHTML;
          localStorage.setItem('aiChatHistory', trimmedHistory);
        } else {
          // Save normally
          localStorage.setItem('aiChatHistory', chatHistory);
        }
      } catch (error) {
        console.error('Error saving chat history to localStorage:', error);
      }
    }
    
    function loadChatHistory() {
      try {
        if (!isLocalStorageAvailable()) {
          console.warn('localStorage is not available. Cannot load chat history.');
          return;
        }
        
        const history = localStorage.getItem('aiChatHistory');
        if (history) {
          const chatHistory = document.getElementById('aiChatHistory');
          chatHistory.innerHTML = history;
          scrollToBottom(chatHistory);
        }
      } catch (error) {
        console.error('Error loading chat history from localStorage:', error);
        
        // If there's an error loading, reset the chat
        document.getElementById('aiChatHistory').innerHTML = `
          <div class="placeholder-text">
            Start a conversation with AI to analyze your spreadsheet data or get help with formulas.
          </div>
        `;
      }
    }
    
    // Add this new function for smooth scrolling
    function scrollToBottom(element) {
      element.scrollTop = element.scrollHeight;
    }
    
    // Initialize
    window.onload = function() {
      // Initialize the tabs
      switchTab('api'); // Start with API tab active
      
      // Initialize chat history if needed
      if (document.getElementById('aiTab').style.display === 'block') {
        loadChatHistory();
      }
      
      // Initialize textarea height
      const messageInput = document.getElementById('aiMessageInput');
      if (messageInput) {
        autoResizeTextarea(messageInput);
      }
      
      // Setup auto-save for chat history
      setInterval(saveChatHistory, 30000); // Save every 30 seconds
      
      console.log("Sidebar initialized successfully");
    };

    // Function to auto-resize textarea dynamically
    function autoResizeTextarea(textarea) {
      textarea.style.height = 'auto';
      textarea.style.height = textarea.scrollHeight + 'px';
    }

    // API Response Functions
    function copyResponse() {
      const resultArea = document.getElementById('resultArea');
      navigator.clipboard.writeText(resultArea.textContent)
        .then(() => showNotification('Response copied to clipboard', 'success'))
        .catch(() => showNotification('Failed to copy response', 'error'));
    }
    
    function addToSheet() {
      const resultArea = document.getElementById('resultArea');
      const button = event.target;
      
      try {
        const data = JSON.parse(resultArea.textContent);
        
        // Show loading state
        button.classList.add('loading');
        button.disabled = true;
        
        // First check if the active sheet has data
        google.script.run
          .withSuccessHandler(hasData => {
            if (hasData) {
              // If there's existing data, show confirmation dialog
              const userChoice = confirm("The active sheet contains data. Do you want to clear it and add the new data?");
              if (!userChoice) {
                // User canceled, reset button state
                button.classList.remove('loading');
                button.disabled = false;
                return;
              }
            }
            
            // Proceed with adding data to sheet (with clear flag set to true)
            google.script.run
              .withSuccessHandler(() => {
                showNotification('Response added to sheet', 'success');
                // Reset button state
                button.classList.remove('loading');
                button.disabled = false;
              })
              .withFailureHandler(error => {
                showNotification('Error adding to sheet: ' + error, 'error');
                // Reset button state
                button.classList.remove('loading');
                button.disabled = false;
              })
              .addResponseToSheet(data, true); // Pass true to indicate we want to clear the sheet
          })
          .withFailureHandler(error => {
            showNotification('Error checking sheet: ' + error, 'error');
            // Reset button state
            button.classList.remove('loading');
            button.disabled = false;
          })
          .checkSheetHasData();
      } catch (e) {
        showNotification('Invalid JSON response', 'error');
        // Reset button state
        button.classList.remove('loading');
        button.disabled = false;
      }
    }
    
    function visualizeResponse() {
      const resultArea = document.getElementById('resultArea');
      const button = event.target;
      
      try {
        const data = JSON.parse(resultArea.textContent);
        
        // Show loading state
        button.classList.add('loading');
        button.disabled = true;
        
        google.script.run
          .withSuccessHandler(visualization => {
            // Remove any existing visualization
            const existingContainer = document.querySelector('.visualization-container');
            if (existingContainer) {
              existingContainer.remove();
            }
            
            const container = document.createElement('div');
            container.className = 'visualization-container active';
            container.innerHTML = `
              <div class="chart-container" id="chartContainer"></div>
            `;
            resultArea.parentNode.appendChild(container);
            
            // Initialize visualization based on data type
            if (Array.isArray(data)) {
              // Handle array data
              if (data.length > 0 && typeof data[0] === 'object') {
                // Table visualization with pagination
                const table = document.createElement('table');
                table.style.width = '100%';
                table.style.borderCollapse = 'collapse';
                
                // Headers
                const headers = Object.keys(data[0]);
                const headerRow = document.createElement('tr');
                headers.forEach(header => {
                  const th = document.createElement('th');
                  th.textContent = header;
                  th.style.padding = '4px 8px';
                  th.style.border = '1px solid #dadce0';
                  headerRow.appendChild(th);
                });
                table.appendChild(headerRow);
                
                // Data rows (limit to first 10 rows)
                data.slice(0, 10).forEach(item => {
                  const row = document.createElement('tr');
                  headers.forEach(header => {
                    const td = document.createElement('td');
                    td.textContent = item[header];
                    td.style.padding = '4px 8px';
                    td.style.border = '1px solid #dadce0';
                    row.appendChild(td);
                  });
                  table.appendChild(row);
                });
                
                container.querySelector('#chartContainer').appendChild(table);
                
                // Add pagination info if there are more rows
                if (data.length > 10) {
                  const paginationInfo = document.createElement('div');
                  paginationInfo.style.marginTop = '8px';
                  paginationInfo.style.fontSize = '12px';
                  paginationInfo.style.color = '#5f6368';
                  paginationInfo.textContent = `Showing 1-10 of ${data.length} rows`;
                  container.appendChild(paginationInfo);
                }
              } else {
                // Simple list visualization
                const list = document.createElement('ul');
                data.slice(0, 10).forEach(item => {
                  const li = document.createElement('li');
                  li.textContent = item;
                  list.appendChild(li);
                });
                container.querySelector('#chartContainer').appendChild(list);
                
                // Add pagination info if there are more items
                if (data.length > 10) {
                  const paginationInfo = document.createElement('div');
                  paginationInfo.style.marginTop = '8px';
                  paginationInfo.style.fontSize = '12px';
                  paginationInfo.style.color = '#5f6368';
                  paginationInfo.textContent = `Showing 1-10 of ${data.length} items`;
                  container.appendChild(paginationInfo);
                }
              }
            } else if (typeof data === 'object') {
              // Handle object data
              const table = document.createElement('table');
              table.style.width = '100%';
              table.style.borderCollapse = 'collapse';
              
              Object.entries(data).forEach(([key, value]) => {
                const row = document.createElement('tr');
                const keyCell = document.createElement('td');
                keyCell.textContent = key;
                keyCell.style.padding = '4px 8px';
                keyCell.style.border = '1px solid #dadce0';
                keyCell.style.fontWeight = 'bold';
                
                const valueCell = document.createElement('td');
                valueCell.textContent = typeof value === 'object' ? JSON.stringify(value) : value;
                valueCell.style.padding = '4px 8px';
                valueCell.style.border = '1px solid #dadce0';
                
                row.appendChild(keyCell);
                row.appendChild(valueCell);
                table.appendChild(row);
              });
              
              container.querySelector('#chartContainer').appendChild(table);
            }
            
            // Reset button state
            button.classList.remove('loading');
            button.disabled = false;
          })
          .withFailureHandler(error => {
            showNotification('Error creating visualization: ' + error, 'error');
            // Reset button state
            button.classList.remove('loading');
            button.disabled = false;
          })
          .createVisualization(data);
      } catch (e) {
        showNotification('Invalid JSON response', 'error');
        // Reset button state
        button.classList.remove('loading');
        button.disabled = false;
      }
    }

    function addQueryParamRow() {
      const container = document.getElementById('queryParamsContainer');
      const row = document.createElement('div');
      row.className = 'query-param-row';
      row.innerHTML = `
        <input type="text" placeholder="Key" class="query-key">
        <input type="text" placeholder="Value" class="query-value">
        <button class="button secondary" onclick="this.parentElement.remove()">Remove</button>
      `;
      container.appendChild(row);
    }

    /**
     * Parses a cURL command and extracts API request details
     * @param {string} curlCommand - The cURL command to parse
     * @return {Object} Object containing parsed API request details
     */
    function parseCurlCommand(curlCommand) {
      try {
        console.log("Parsing cURL command:", curlCommand);
        
        // Initialize result object
        const result = {
          url: '',
          method: 'GET',
          headers: {},
          body: null,
          queryParams: {}
        };
        
        // Helper function to extract quoted strings
        function extractQuoted(str) {
          // Remove outer quotes if they exist
          str = str.replace(/^['"](.*)['"]$/, '$1');
          return str;
        }
        
        // Normalize command by ensuring spaces after backslashes
        let normalizedCommand = curlCommand.replace(/\\\s*\n/g, ' ');
        
        // Tokenize the cURL command, handling quoted strings
        let tokens = [];
        let inQuote = null;
        let currentToken = '';
        
        for (let i = 0; i < normalizedCommand.length; i++) {
          const char = normalizedCommand[i];
          
          if ((char === "'" || char === '"') && (i === 0 || normalizedCommand[i-1] !== '\\')) {
            if (inQuote === char) {
              // End of quoted string
              currentToken += char;
              tokens.push(currentToken);
              currentToken = '';
              inQuote = null;
            } else if (inQuote === null) {
              // Start of quoted string
              if (currentToken.trim()) {
                tokens.push(currentToken.trim());
              }
              currentToken = char;
              inQuote = char;
            } else {
              // Quote within another type of quote
              currentToken += char;
            }
          } else if (char === ' ' && inQuote === null) {
            if (currentToken.trim()) {
              tokens.push(currentToken.trim());
            }
            currentToken = '';
          } else {
            currentToken += char;
          }
        }
        
        if (currentToken.trim()) {
          tokens.push(currentToken.trim());
        }
        
        // Log tokens for debugging
        console.log("Tokens after parsing:", tokens);
        
        // Remove 'curl' if it's the first token
        if (tokens.length > 0 && tokens[0].toLowerCase() === 'curl') {
          tokens.shift();
        }
        
        // Process tokens
        for (let i = 0; i < tokens.length; i++) {
          const token = tokens[i];
          
          if (token === '-X' || token === '--request') {
            // HTTP method
            if (i + 1 < tokens.length) {
              result.method = extractQuoted(tokens[i + 1]).toUpperCase();
              i++;
            }
          } else if (token === '-H' || token === '--header') {
            // Headers
            if (i + 1 < tokens.length) {
              const headerStr = extractQuoted(tokens[i + 1]);
              const splitIndex = headerStr.indexOf(':');
              if (splitIndex > 0) {
                const key = headerStr.substring(0, splitIndex).trim();
                const value = headerStr.substring(splitIndex + 1).trim();
                result.headers[key] = value;
              }
              i++;
            }
          } else if (token === '-d' || token === '--data') {
            // Request body
            if (i + 1 < tokens.length) {
              let bodyStr = extractQuoted(tokens[i + 1]);
              console.log("Extracted body string:", bodyStr);
              try {
                // Try to parse as JSON first
                result.body = JSON.parse(bodyStr);
                console.log("Parsed body as JSON:", result.body);
              } catch (e) {
                // If not valid JSON, use as is
                result.body = bodyStr;
                console.log("Body is not JSON, used as string:", result.body);
              }
              i++;
            }
          } else if (token === '--location' || token === '-L') {
            // URL should be in the next token for --location
            if (i + 1 < tokens.length) {
              result.url = extractQuoted(tokens[i + 1]);
              i++;
            }
          } else if (token.startsWith('http://') || token.startsWith('https://')) {
            // URL
            result.url = extractQuoted(token);
            console.log("Extracted URL:", result.url);
          }
        }
        
        // Extract query parameters from URL if present
        if (result.url.includes('?')) {
          const [baseUrl, queryString] = result.url.split('?');
          result.url = baseUrl;
          
          const queryParams = queryString.split('&');
          for (const param of queryParams) {
            const [key, value] = param.split('=');
            if (key) {
              result.queryParams[key] = value || '';
            }
          }
        }
        
        // If there's a body but no method specified, assume POST
        if (!result.method || result.method === 'GET') {
          if (result.body) {
            result.method = 'POST';
          }
        }
        
        // If there's a JSON body but no Content-Type, add application/json
        if (result.body && !result.headers['Content-Type']) {
          try {
            JSON.stringify(result.body);
            result.headers['Content-Type'] = 'application/json';
          } catch (e) {
            // Not JSON, don't add Content-Type
          }
        }
        
        console.log("Parsed cURL result:", JSON.stringify(result, null, 2));
        return result;
      } catch (error) {
        console.error('Error parsing cURL command:', error);
        throw new Error('Invalid cURL command format: ' + error.message);
      }
    }

    function importFromCurl() {
      const curlCommand = document.getElementById('curlInput').value.trim();
      if (!curlCommand) {
        showNotification('Please enter a cURL command', 'error');
        return;
      }
      
      try {
        // Parse the cURL command in the frontend
        const result = parseCurlCommand(curlCommand);
        
        // Fill in the form fields with parsed data
        document.getElementById('apiUrl').value = result.url;
        document.getElementById('apiMethod').value = result.method;
        document.getElementById('headers').value = JSON.stringify(result.headers, null, 2);
        
        // Handle body - ensure it's properly formatted JSON without extra quotes
        if (result.body) {
          try {
            let bodyStr = result.body;
            
            // Remove leading and trailing single or double quotes if present
            if ((bodyStr.startsWith("'") && bodyStr.endsWith("'")) || 
                (bodyStr.startsWith('"') && bodyStr.endsWith('"'))) {
              bodyStr = bodyStr.slice(1, -1);
            }
            
            // Try to parse the body as JSON
            const parsedBody = JSON.parse(bodyStr);
            document.getElementById('apiBody').value = JSON.stringify(parsedBody, null, 2);
          } catch (e) {
            // If parsing fails, use the body as is
            document.getElementById('apiBody').value = bodyStr;
          }
        }
        
        // Handle query parameters
        if (Object.keys(result.queryParams).length > 0) {
          // Clear existing query parameter rows
          const container = document.getElementById('queryParamsContainer');
          container.innerHTML = '';
          
          // Add new rows for each query parameter
          Object.entries(result.queryParams).forEach(([key, value]) => {
            const row = document.createElement('div');
            row.className = 'query-param-row';
            row.innerHTML = `
              <input type="text" placeholder="Key" class="query-key" value="${key}">
              <input type="text" placeholder="Value" class="query-value" value="${value}">
              <button class="button secondary" onclick="this.parentElement.remove()">Remove</button>
            `;
            container.appendChild(row);
          });
        }
        
        showNotification('cURL command imported successfully', 'success');
      } catch (error) {
        showNotification('Error parsing cURL command: ' + error.message, 'error');
      }
    }

    // Function to check if localStorage is available
    function isLocalStorageAvailable() {
      try {
        const test = 'test';
        localStorage.setItem(test, test);
        localStorage.removeItem(test);
        return true;
      } catch(e) {
        return false;
      }
    }
  </script>
</body>
</html> 